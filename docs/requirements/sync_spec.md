# 同期仕様（MVP案）

## 目的
- CloudKit（iCloud）同期の「何を・いつ・どうやって」を確定する
- エラー時の挙動（ローカル限定/未同期表示/再同期）を具体化する

## 前提（確定）
- 同期基盤: CloudKit（iCloud）
- ログイン: Sign in with Apple（必須）
- 端末がiCloud未サインイン: アプリ利用不可（ブロッキング画面→設定誘導）
- 競合: LWW（最終更新が勝つ）＋負けた内容はコピー/スナップショットとして残す

## 今回決めたこと
- 同期対象: 標準（本文 / アウトライン / プロット / キャラクター / 情報）
- 同期タイミング: 入力＋遅延（2秒デバウンス）

## 1. 同期対象（決める）
- 最小: 本文のみ
- 標準: 本文 / アウトライン / プロット / キャラクター / 情報（採用）
- 履歴: スナップショット（確定保存）も同期するか？
  - A: 同期する（端末間で履歴が揃う）（採用）
  - B: 同期しない（各端末ローカル）

## 2. 同期タイミング（決める）
- A: 手動（「同期」ボタン）
- B: 保存時のみ（明示保存のたび）
- C: 入力＋遅延（2秒デバウンス）（採用）
- 注意: Cは同期回数が増えるため、競合/未同期/リトライ設計が重要

## 3. ローカル優先の保存（決める）
- 先にローカルへ保存し、同期は後追い（失敗しても作業は継続）
- 未同期がある場合の表示:
  - 作品一覧に「未同期」バッジ
  - エディタ上部に「同期中/未同期」表示

## 4. 競合（LWW＋コピー）の具体仕様（決める）
- いつ「競合」と判断するか（例: サーバー側の更新が自端末の編集開始以降に入っていた）
- コピーの置き場所:
  - A: 「スナップショット」として履歴に残す（採用）
  - B: 「競合コピー」として別ファイル/別作品として残す
- コピーの命名:
  - 例: `競合（iPhone） 2026-01-20 12:34`

## 4.1 同時編集の扱い（MVP方針）
- 同一作品を複数端末で同時編集しても「入力＋遅延」で同期は走る前提。
- 競合が起きたら LWW を適用し、負けた内容は「競合スナップショット」として必ず残す（内容が消えないことを優先）。

## 5. iCloud利用不可時の挙動（確定＋詳細化）
- iCloud未サインイン: アプリ利用不可（ブロッキング画面→設定誘導）
- iCloud/CloudKit無効化（端末はiCloudサインイン済み）: ローカル限定（同期UIは無効＋案内）
- 容量不足: ローカル保存は継続、同期は失敗→未同期表示→容量確保後に再同期
- 制限（MDM/スクリーンタイム等）: ローカル限定＋理由表示

## 6. MVPの受け入れ条件（案）
- iPhoneで作成した作品が、同一アカウントの別端末で表示/編集できる
- iCloud/CloudKitが無効（端末がiCloudにサインイン済みの場合）でもローカルで作業でき、復帰後に再同期できる
- 競合が起きても内容が消えず、コピーが残る

## スナップショット作成ルール（決定）
- 手動のみ（ユーザー操作で「確定保存」を実行）

## スナップショットのメタデータ（決定）
- タイトル: 保存
- メモ: 保存
- 作成日時: 自動で保存
- 端末名: 自動で保存

## スナップショット保存方式（方針）
### 論理（ユーザーに提供する体験）
- スナップショットは「その時点の状態を丸ごと残す版」として扱う（いつでもプレビュー/復元できる）。

### 物理（内部の保存のしかた＝容量最適化）
- 目標: ユーザー体験はスナップショットのまま、内部では無駄な重複を減らす。
- 方針案（段階的）:
  1) 圧縮: 本文等のテキストは圧縮して保存（CloudKitのレコード/アセットに格納）。
  2) 重複排除: 内容ハッシュ（例: SHA-256）で同一内容を再利用し、同じデータを二重保存しない。
     - 例: スナップショットは「ファイル→コンテンツID」の参照だけを持つ（実体は1回だけ保存）。
  3) 差分（必要になったら）: 連続スナップショット間の差分圧縮を導入し、一定間隔でフルを打つ（復元コスト/破損耐性のため）。
- まずは 1) + 2) をMVPの現実解候補とし、3) は容量要件が出てから検討する。
